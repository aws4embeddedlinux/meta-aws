From 38f64a7d74f0f6857c04afdfddd96603a60eb083 Mon Sep 17 00:00:00 2001
From: Andrew Hopkins <andhop@amazon.com>
Date: Thu, 13 Jul 2023 14:43:05 -0700
Subject: [PATCH] Add a shared library build with HAProxy to the CI (#1092)

---
 .../ci/integration/run_haproxy_integration.sh | 43 ++++++++++++-------
 1 file changed, 27 insertions(+), 16 deletions(-)

diff --git a/tests/ci/integration/run_haproxy_integration.sh b/tests/ci/integration/run_haproxy_integration.sh
index ac3753f8a..8b44ea3f4 100755
--- a/tests/ci/integration/run_haproxy_integration.sh
+++ b/tests/ci/integration/run_haproxy_integration.sh
@@ -21,6 +21,24 @@ SCRATCH_FOLDER=${SYS_ROOT}/"scratch"
 AWS_LC_BUILD_FOLDER="${SCRATCH_FOLDER}/aws-lc-build"
 AWS_LC_INSTALL_FOLDER="${SCRATCH_FOLDER}/aws-lc-install"
 HAPROXY_SRC="${SCRATCH_FOLDER}/haproxy"
+export LD_LIBRARY_PATH="${AWS_LC_INSTALL_FOLDER}/lib"
+
+function build_and_test_haproxy() {
+  cd ${HAPROXY_SRC}
+  make CC="${CC}" -j ${NUM_CPU_THREADS} TARGET=generic USE_OPENSSL=1 SSL_INC="${AWS_LC_INSTALL_FOLDER}/include" SSL_LIB="${AWS_LC_INSTALL_FOLDER}/lib/"
+
+  # These tests pass when run locally but are not supported in CodeBuild, see CryptoAlg-1965
+  excluded_tests=("mcli_show_info.vtc" "mcli_start_progs.vtc" "tls_basic_sync.vtc" "tls_basic_sync_wo_stkt_backend.vtc" "acl_cli_spaces.vtc" "http_reuse_always.vtc")
+  test_paths=""
+
+  for test in reg-tests/**/*; do
+      if [[ "$test" == *.vtc ]] && [[ ! " ${excluded_tests[*]} " =~ $(basename "$test") ]]; then
+          test_paths+="$(realpath "$test") "
+      fi
+  done
+
+  ./scripts/run-regtests.sh "$test_paths"
+}
 
 # Make script execution idempotent.
 mkdir -p ${SCRATCH_FOLDER}
@@ -29,24 +47,17 @@ cd ${SCRATCH_FOLDER}
 
 mkdir -p ${AWS_LC_BUILD_FOLDER} ${AWS_LC_INSTALL_FOLDER}
 git clone --depth 1 https://github.com/haproxy/haproxy.git
-ls
-
-aws_lc_build ${SRC_ROOT} ${AWS_LC_BUILD_FOLDER} ${AWS_LC_INSTALL_FOLDER}
-
-cd ${HAPROXY_SRC}
-
-make CC="${CC}" -j ${NUM_CPU_THREADS} TARGET=generic USE_OPENSSL=1 SSL_INC="${AWS_LC_INSTALL_FOLDER}/include" SSL_LIB="${AWS_LC_INSTALL_FOLDER}/lib/"
+cd haproxy
 ./scripts/build-vtest.sh
 export VTEST_PROGRAM=$(realpath ../vtest/vtest)
 
-# These tests pass when run local but are not supported in CodeBuild CryptoAlg-1965
-excluded_tests=("mcli_show_info.vtc" "mcli_start_progs.vtc" "tls_basic_sync.vtc" "tls_basic_sync_wo_stkt_backend.vtc" "acl_cli_spaces.vtc" "http_reuse_always.vtc")
-test_paths=""
+# Test with static AWS-LC libraries
+aws_lc_build ${SRC_ROOT} ${AWS_LC_BUILD_FOLDER} ${AWS_LC_INSTALL_FOLDER} -DBUILD_SHARED_LIBS=0
+build_and_test_haproxy $HAPROXY_SRC
 
-for test in reg-tests/**/*; do
-    if [[ "$test" == *.vtc ]] && [[ ! " ${excluded_tests[*]} " =~ $(basename "$test") ]]; then
-        test_paths+="$(realpath "$test") "
-    fi
-done
+rm -rf ${AWS_LC_INSTALL_FOLDER}/*
+rm -rf ${AWS_LC_BUILD_FOLDER}/*
 
-./scripts/run-regtests.sh "$test_paths"
+# Test with shared AWS-LC libraries
+aws_lc_build ${SRC_ROOT} ${AWS_LC_BUILD_FOLDER} ${AWS_LC_INSTALL_FOLDER} -DBUILD_SHARED_LIBS=1
+build_and_test_haproxy $HAPROXY_SRC
