From 3990d32dab1a85593be7aa261b4dd1019b62efde Mon Sep 17 00:00:00 2001
From: Justin W Smith <103147162+justsmth@users.noreply.github.com>
Date: Fri, 10 Feb 2023 09:35:11 -0500
Subject: [PATCH] Different symbols prefix for FIPS (#798)

---
 bindings/rust/aws-lc-fips-sys-template/build/main.rs | 2 +-
 bindings/rust/generate/generate-fips.sh              | 2 +-
 bindings/rust/generate/generate.sh                   | 2 +-
 tests/ci/docker_images/rust/README.md                | 6 ++++++
 4 files changed, 9 insertions(+), 3 deletions(-)

diff --git a/bindings/rust/aws-lc-fips-sys-template/build/main.rs b/bindings/rust/aws-lc-fips-sys-template/build/main.rs
index 7cacf1b01..8ad96b0f6 100644
--- a/bindings/rust/aws-lc-fips-sys-template/build/main.rs
+++ b/bindings/rust/aws-lc-fips-sys-template/build/main.rs
@@ -98,7 +98,7 @@ fn get_platform_output_path() -> PathBuf {
 const VERSION: &str = env!("CARGO_PKG_VERSION");
 
 fn prefix_string() -> String {
-    format!("aws_lc_{}", VERSION.to_string().replace('.', "_"))
+    format!("aws_lc_fips_{}", VERSION.to_string().replace('.', "_"))
 }
 
 fn test_perl_command() -> bool {
diff --git a/bindings/rust/generate/generate-fips.sh b/bindings/rust/generate/generate-fips.sh
index 6b6a11ec7..b54bf93e1 100755
--- a/bindings/rust/generate/generate-fips.sh
+++ b/bindings/rust/generate/generate-fips.sh
@@ -94,7 +94,7 @@ mkdir -p "${TMP_DIR}"
 determine_generate_version
 
 # Crate preparation.
-if [[ ! -r "${SYMBOLS_FILE}" ]] || [[! -d "${AWS_LC_FIPS_DIR}" ]]; then
+if [[ ! -r "${SYMBOLS_FILE}" || ! -d "${AWS_LC_FIPS_DIR}" ]]; then
   # Symbols file must be consistent with AWS-LC source directory
   rm -f "${SYMBOLS_FILE}"
   rm -rf "${AWS_LC_FIPS_DIR}"
diff --git a/bindings/rust/generate/generate.sh b/bindings/rust/generate/generate.sh
index 53e50febb..f09ff8cb5 100755
--- a/bindings/rust/generate/generate.sh
+++ b/bindings/rust/generate/generate.sh
@@ -87,7 +87,7 @@ mkdir -p "${TMP_DIR}"
 determine_generate_version
 
 # Crate preparation.
-if [[ ! -r "${SYMBOLS_FILE}" ]] || [[! -d "${AWS_LC_SRC_DIR}" ]]; then
+if [[ ! -r "${SYMBOLS_FILE}" || ! -d "${AWS_LC_SRC_DIR}" ]]; then
   # Symbols file must be consistent with AWS-LC source directory
   rm -f "${SYMBOLS_FILE}"
   rm -rf "${AWS_LC_SRC_DIR}"
diff --git a/tests/ci/docker_images/rust/README.md b/tests/ci/docker_images/rust/README.md
index d5b610311..12a6a8d9a 100644
--- a/tests/ci/docker_images/rust/README.md
+++ b/tests/ci/docker_images/rust/README.md
@@ -23,3 +23,9 @@ $ sudo yum install -y qemu-system-aarch64 qemu-system-x86 qemu-user-binfmt
 $ docker buildx create --name=container --driver=docker-container --use
 $ docker run --privileged --rm tonistiigi/binfmt --install all
 ```
+
+This may periodically need to be reset:
+```
+$ docker run --privileged --rm tonistiigi/binfmt --uninstall arm64,arm,riscv64,mips64le,s390x,ppc64le,mips64
+$ docker run --privileged --rm tonistiigi/binfmt --install all
+```
\ No newline at end of file
