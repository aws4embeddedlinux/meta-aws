From 1d7c26e71bb282705f2617f74aca9b7500e3cd6a Mon Sep 17 00:00:00 2001
From: Sean McGrail <549813+skmcgrail@users.noreply.github.com>
Date: Fri, 28 Apr 2023 05:32:48 -0700
Subject: [PATCH] aws-lc-rs workflow (#971)

Co-authored-by: Justin W Smith <103147162+justsmth@users.noreply.github.com>
---
 .github/workflows/aws-lc-rs.yml | 65 +++++++++++++++++++++++++++++++++
 1 file changed, 65 insertions(+)
 create mode 100644 .github/workflows/aws-lc-rs.yml

diff --git a/.github/workflows/aws-lc-rs.yml b/.github/workflows/aws-lc-rs.yml
new file mode 100644
index 000000000..6688c212d
--- /dev/null
+++ b/.github/workflows/aws-lc-rs.yml
@@ -0,0 +1,65 @@
+name: aws-lc-rs sanity tests
+on:
+  push:
+    branches: [ '*' ]
+  pull_request:
+    branches: [ '*' ]
+env:
+  CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse
+  GOPROXY: https://proxy.golang.org,direct
+jobs:
+  standard:
+    runs-on: ubuntu-latest
+    steps:
+
+      - uses: actions/checkout@v3
+        with:
+          repository: awslabs/aws-lc-rs
+          path: ./aws-lc-rs
+          submodules: false
+      - uses: actions-rs/toolchain@v1
+        with:
+          toolchain: stable
+          override: true
+      - uses: actions-rs/cargo@v1
+        with:
+          command: install
+          args: rust-script
+      - name: Install OS Dependencies
+        run: |
+          sudo apt-get -y --no-install-recommends install cmake gcc clang ninja-build golang
+      - name: Remove aws-lc submodule from crate directory
+        working-directory: ./aws-lc-rs/aws-lc-sys
+        run: |
+          rm -rf aws-lc
+      - uses: actions/checkout@v3
+        with:
+          path: ./aws-lc-rs/aws-lc-sys/aws-lc
+      - name: Regenerate aws-lc-sys crate
+        working-directory: ./aws-lc-rs/aws-lc-sys
+        run: |
+          rm -rf symbols/*
+          rm -rf generated-include/*
+          ../scripts/generate/_collect_symbols_build.sh -c aws-lc-sys
+          ../scripts/generate/_generate_prefix_headers.sh -c aws-lc-sys
+          ../scripts/generate/_generate_bindings.sh -c aws-lc-sys
+      - name: aws-lc-sys build
+        working-directory: ./aws-lc-rs/aws-lc-sys
+        run: |
+          cargo build
+      - name: aws-lc-sys test
+        working-directory: ./aws-lc-rs/aws-lc-sys
+        run: |
+          cargo test
+      - name: aws-lc-sys packaging
+        working-directory: ./aws-lc-rs/aws-lc-sys
+        run: |
+          cargo package --allow-dirty
+      - name: aws-lc-rs build
+        working-directory: ./aws-lc-rs/aws-lc-rs
+        run: |
+          cargo build
+      - name: aws-lc-rs test
+        working-directory: ./aws-lc-rs/aws-lc-rs
+        run: |
+          cargo test
